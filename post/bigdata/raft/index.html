<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Raft - HLDay</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="hlday" /><meta name="description" content="Raft is a consensus algorithm designed as an alternative to the Paxos family of algorithms. It was meant to be more understandable than Paxos by means of separation of logic, but it is also formally proven safe and offers some additional features. Raft offers a generic way to distribute a state machine across a cluster of computing systems, ensuring that each node in the cluster agrees upon the same series of state transitions. It has a number of open-source reference implementations, with full-specification implementations in Go, C&#43;&#43;, Java, and Scala. It is named after Reliable, Replicated, Redundant, And Fault-Tolerant." /><meta name="keywords" content="hlday, blog, go, python, linux, shell" />





<script async src="https://www.googletagmanager.com/gtag/js?id=G-59Y2CYW544"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-59Y2CYW544');
</script>

<meta name="generator" content="Hugo 0.93.2 with theme even" />


<link rel="canonical" href="/post/bigdata/raft/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<link href="/sass/main.min.b5a744db6de49a86cadafb3b70f555ab443f83c307a483402259e94726b045ff.css" rel="stylesheet">



<meta property="og:title" content="Raft" />
<meta property="og:description" content="Raft is a consensus algorithm designed as an alternative to the Paxos family of algorithms. It was meant to be more understandable than Paxos by means of separation of logic, but it is also formally proven safe and offers some additional features. Raft offers a generic way to distribute a state machine across a cluster of computing systems, ensuring that each node in the cluster agrees upon the same series of state transitions. It has a number of open-source reference implementations, with full-specification implementations in Go, C&#43;&#43;, Java, and Scala. It is named after Reliable, Replicated, Redundant, And Fault-Tolerant." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/bigdata/raft/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-03-08T14:42:17+08:00" />
<meta property="article:modified_time" content="2022-03-08T14:42:17+08:00" />

<meta itemprop="name" content="Raft">
<meta itemprop="description" content="Raft is a consensus algorithm designed as an alternative to the Paxos family of algorithms. It was meant to be more understandable than Paxos by means of separation of logic, but it is also formally proven safe and offers some additional features. Raft offers a generic way to distribute a state machine across a cluster of computing systems, ensuring that each node in the cluster agrees upon the same series of state transitions. It has a number of open-source reference implementations, with full-specification implementations in Go, C&#43;&#43;, Java, and Scala. It is named after Reliable, Replicated, Redundant, And Fault-Tolerant."><meta itemprop="datePublished" content="2022-03-08T14:42:17+08:00" />
<meta itemprop="dateModified" content="2022-03-08T14:42:17+08:00" />
<meta itemprop="wordCount" content="4121">
<meta itemprop="keywords" content="分布式,go," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Raft"/>
<meta name="twitter:description" content="Raft is a consensus algorithm designed as an alternative to the Paxos family of algorithms. It was meant to be more understandable than Paxos by means of separation of logic, but it is also formally proven safe and offers some additional features. Raft offers a generic way to distribute a state machine across a cluster of computing systems, ensuring that each node in the cluster agrees upon the same series of state transitions. It has a number of open-source reference implementations, with full-specification implementations in Go, C&#43;&#43;, Java, and Scala. It is named after Reliable, Replicated, Redundant, And Fault-Tolerant."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">HLDay</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/image/bing">
        <li class="mobile-menu-item">BingDailyPicture</li>
      </a><a href="/post/preview/">
        <li class="mobile-menu-item">Share</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel" style="max-width: 75%; width: 70% !important;">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">HLDay</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/image/bing">BingDailyPicture</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/preview/">Share</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Raft</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-03-08 </span>
        <div class="post-category">
            <a href="/categories/go/"> go </a>
            </div>
          <span class="more-meta"> 4121 words </span>
          <span class="more-meta"> 9 mins read </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> times read </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc" style="position: fixed !important;width:14%;top:10%;right: 1% !important;">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#raft选举过程">Raft选举过程</a>
          <ul>
            <li><a href="#角色">角色</a></li>
            <li><a href="#选举过程">选举过程</a></li>
          </ul>
        </li>
        <li><a href="#log-replication">Log replication</a>
          <ul>
            <li><a href="#日志格式">日志格式</a></li>
            <li><a href="#日志处理流程">日志处理流程</a></li>
          </ul>
        </li>
        <li><a href="#一些问题">一些问题</a>
          <ul>
            <li><a href="#通过k8s部署的3节点consul先后挂掉两个节点后无法正常工作">通过k8s部署的3节点consul先后挂掉两个节点后无法正常工作</a></li>
          </ul>
        </li>
        <li><a href="#有用的链接">有用的链接</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="raft选举过程">Raft选举过程</h2>
<h3 id="角色">角色</h3>
<p>每个节点存在三种不同的角色：</p>
<ul>
<li>Follower</li>
<li>Candidate</li>
<li>Leader</li>
</ul>
<p>并且每个节点同一时刻只能是其中一种角色。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Check if we are doing a shutdown
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">shutdownCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Clear the leader to prevent forwarding
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">r</span><span class="p">.</span><span class="nf">setLeader</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Enter into a sub-FSM
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">switch</span> <span class="nx">r</span><span class="p">.</span><span class="nf">getState</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">Follower</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">r</span><span class="p">.</span><span class="nf">runFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">Candidate</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">r</span><span class="p">.</span><span class="nf">runCandidate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">Leader</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="nx">r</span><span class="p">.</span><span class="nf">runLeader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="follower">Follower</h4>
<p>节点处于Follower状态时，会首先初始化一个随机过期时间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">heartbeatTimer</span> <span class="o">:=</span> <span class="nf">randomTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">HeartbeatTimeout</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果超过该时间没有和leader成功通信，则该节点会认为leader丢失，并尝试进入Candidate状态。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="k">case</span> <span class="o">&lt;-</span><span class="nx">heartbeatTimer</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Restart the heartbeat timer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">heartbeatTimer</span> <span class="p">=</span> <span class="nf">randomTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">HeartbeatTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Check if we have had a successful contact
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">lastContact</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">LastContact</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">().</span><span class="nf">Sub</span><span class="p">(</span><span class="nx">lastContact</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">HeartbeatTimeout</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="k">continue</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">// Heartbeat failed! Transition to the candidate state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nx">lastLeader</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">Leader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">r</span><span class="p">.</span><span class="nf">setLeader</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latestIndex</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;no known peers, aborting election&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">!</span><span class="nx">didWarn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;no known peers, aborting election&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nx">didWarn</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latestIndex</span> <span class="o">==</span> <span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">committedIndex</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">				<span class="p">!</span><span class="nf">hasVote</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latest</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">localID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;not part of stable configuration, aborting election&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">if</span> <span class="p">!</span><span class="nx">didWarn</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">					<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;not part of stable configuration, aborting election&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nx">didWarn</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">				<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;heartbeat timeout reached, starting election&#34;</span><span class="p">,</span> <span class="s">&#34;last-leader&#34;</span><span class="p">,</span> <span class="nx">lastLeader</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">metrics</span><span class="p">.</span><span class="nf">IncrCounter</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;raft&#34;</span><span class="p">,</span> <span class="s">&#34;transition&#34;</span><span class="p">,</span> <span class="s">&#34;heartbeat_timeout&#34;</span><span class="p">},</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="nx">r</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">Candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Follower节点会处理一些RPC请求</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">processRPC</span><span class="p">(</span><span class="nx">rpc</span> <span class="nx">RPC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">checkRPCHeader</span><span class="p">(</span><span class="nx">rpc</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rpc</span><span class="p">.</span><span class="nf">Respond</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">switch</span> <span class="nx">cmd</span> <span class="o">:=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">Command</span><span class="p">.(</span><span class="kd">type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">AppendEntriesRequest</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">appendEntries</span><span class="p">(</span><span class="nx">rpc</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">RequestVoteRequest</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">requestVote</span><span class="p">(</span><span class="nx">rpc</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">InstallSnapshotRequest</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">installSnapshot</span><span class="p">(</span><span class="nx">rpc</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">case</span> <span class="o">*</span><span class="nx">TimeoutNowRequest</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">timeoutNow</span><span class="p">(</span><span class="nx">rpc</span><span class="p">,</span> <span class="nx">cmd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;got unexpected command&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;command&#34;</span><span class="p">,</span> <span class="nx">hclog</span><span class="p">.</span><span class="nf">Fmt</span><span class="p">(</span><span class="s">&#34;%#v&#34;</span><span class="p">,</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">Command</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rpc</span><span class="p">.</span><span class="nf">Respond</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;unexpected command&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>其中包括RequestVoteRequest，即请求成为leader的选举请求，如果节点发现</p>
<ol>
<li>存在leader且leader!=请求的节点且不处于leader切换阶段：拒绝选举请求</li>
<li><code>req.Term &lt; r.getCurrentTerm()</code>：拒绝选举请求</li>
<li><code>req.Term &gt; r.getCurrentTerm()</code>: 进入Follower状态并将当前的Term设置为req.Term</li>
<li><code>lastTerm &gt; req.LastLogTerm</code>: 拒绝选举请求</li>
<li><code>lastTerm == req.LastLogTerm &amp;&amp; lastIdx &gt; req.LastLogIndex</code>：拒绝选举请求
从以上5中情况可以看到，选举并不仅仅是根据时间来确定的（先到先得），而是根据时间，存储情况来决定节点是否投票给对应的Candidate，如果集群中一个节点的存储落后于集群中其他节点，即使该节点先发起Leader选举请求，也会被集群中其他节点拒绝。</li>
</ol>
<h4 id="candidate">Candidate</h4>
<p>如果节点超时没有收到leader的心跳，则会进入Candidate状态。Candidate状态开始的时候，节点会首先给自己投一票并且初始化一个随机超时时间，随后会计算需要的投票的节点数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">voteCh</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">electSelf</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">electionTimer</span> <span class="o">:=</span> <span class="nf">randomTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">ElectionTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">votesNeeded</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">quorumSize</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>votesNeeded的计算方式为配置中的最后的所有的节点数/2+1，如果集群中只存在两个活着的节点，则需要的最小投票数量为2</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">quorumSize</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">voters</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">server</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">Servers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">server</span><span class="p">.</span><span class="nx">Suffrage</span> <span class="o">==</span> <span class="nx">Voter</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">voters</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">voters</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果candidate收到rpc的回复，则会：</p>
<ol>
<li><code>vote.Term &gt; r.getCurrentTerm()</code>：进入follower状态</li>
<li><code>vote.Granted==true</code>：grantedVotes++，如果grantedVotes &gt;= votesNeeded，则进入leader状态</li>
</ol>
<p>所以Candidate是一种中间状态，每次选举会存在三种结果</p>
<ul>
<li>超时重新进行选举；</li>
<li>发现req.Term大于自己的term则进入Follower状态；</li>
<li>获取足够多的投票进入Leader状态；</li>
</ul>
<h4 id="leader">Leader</h4>
<p>Leader的运行逻辑比较简单，首先初始化一些leader的配置，然后运行一个死循环<code>r.leaderLoop()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">leaderLoop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// stepDown is used to track if there is an inflight log that
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// would cause us to lose leadership (specifically a RemovePeer of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ourselves). If this is the case, we must not allow any logs to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// be processed in parallel, otherwise we are basing commit on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// only a single peer (ourself) and replicating to an undefined set
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// of peers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">stepDown</span> <span class="o">:=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lease</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">After</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">conf</span><span class="p">.</span><span class="nx">LeaderLeaseTimeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="nx">r</span><span class="p">.</span><span class="nf">getState</span><span class="p">()</span> <span class="o">==</span> <span class="nx">Leader</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">rpc</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">rpcCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">leaderState</span><span class="p">.</span><span class="nx">stepDown</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">future</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">leadershipTransferCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">leaderState</span><span class="p">.</span><span class="nx">commitCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">v</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">verifyCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">future</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">userRestoreCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">future</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">configurationsCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">future</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nf">configurationChangeChIfStable</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">b</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">bootstrapCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="nx">newLog</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">applyCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">lease</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">r</span><span class="p">.</span><span class="nx">shutdownCh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Leader需要处理各种RPC请求，写入数据，并检测集群的状态等。Leader可能会退化为Follower：</p>
<ul>
<li>如果在LeaderLeaseTimeout时间段内，Leader并未与集群中大多数节点成功通信，则Leader会退化为Follower；</li>
<li>如果Leader接收到比当前term更大的term，则会退化为Follower</li>
</ul>
<p>所以上述三种状态可以用下图表示</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com/71fa8524f2fdb96a804db1c20194352e.png" alt="20220308170158"></p>
<p>同时term可以用下图来表示</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com/1f881afea333cd0d531cac8c04dbec83.png" alt="20220308170249"></p>
<h3 id="选举过程">选举过程</h3>
<ol>
<li>
<p>节点在加入集群后处于follower状态；</p>
</li>
<li>
<p>如果follower节点在超时时间（election timeout）后没有收到leader的心跳，会进入candidate状态（开启一个新的election term），candidate状态下会发起选举投票：</p>
<ol>
<li>candidate会首先给自己投票</li>
<li>然后给所有节点发送一个投票消息</li>
<li>如果收到半数以上节点的同意请求则进入leader状态、然后发送<code>Append Entries(会按照heartbeat timeout周期性的发送消息)</code>消息给所有节点</li>
</ol>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/raft-leader-selection-follower-candidate.png" alt="raft-leader-selection-follower-candidate"></p>
<blockquote>
<p>The election timeout is the amount of time a follower waits until becoming a candidate. The election timeout is randomized to be between 150ms and 300ms.</p>
<p>通过随机的选举超时可以有效避免脑裂问题：5节点，宕机一个节点，如果两个candidate同时发起请求，而只收到两票，就都不会赢得选举，然后随机等待一个election timeout，然后再次发起请求，先发起请求的节点成为leader的概率要远大于后发起请求的节点；</p>
</blockquote>
</li>
<li>
<p>其他节点收到投票后会有两种选择：</p>
<ol>
<li>如果在election term没有投过票则同意选举请求、重置election timeout并进入follower状态</li>
<li>拒绝选举请求</li>
</ol>
</li>
</ol>
<h2 id="log-replication">Log replication</h2>
<h3 id="日志格式">日志格式</h3>
<p>log的数据结构如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Log</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Index holds the index of the log entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Index</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Term holds the election term of the log entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Term</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Type holds the type of the log entry.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Type</span> <span class="nx">LogType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Data holds the log entry&#39;s type-specific data.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Data</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Extensions holds an opaque byte slice of information for middleware. It
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// is up to the client of the library to properly modify this as it adds
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// layers and remove those layers when appropriate. This value is a part of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the log, so very large values could cause timing issues.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// N.B. It is _up to the client_ to handle upgrade paths. For instance if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// using this with go-raftchunking, the client should ensure that all Raft
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// peers are using a version that can handle that extension before ever
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// actually triggering chunking behavior. It is sometimes sufficient to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ensure that non-leaders are upgraded first, then the current leader is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// upgraded, but a leader changeover during this process could lead to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// trouble, so gating extension behavior via some flag in the client
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// program is also a good idea.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Extensions</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>log由index，term，type和data组成</p>
<h3 id="日志处理流程">日志处理流程</h3>
<ol>
<li>
<p>所有的请求都需要有Leader处理，并且都会被追加到Leader的log中，如下图所示，client发送了<code>set a=1</code>的请求，leader接收到请求后将数据存储到log中，但是此时并没有commit，所以leader不会更新当前a的值。</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/raft-log-replica-set-to-leader.png" alt="raft-log-replica-set-to-leader"></p>
</li>
<li>
<p>为了完成commit，Leader首先向所有的Follower发送replicate请求，然后等待集群中大多数节点返回确认信息</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/raft-log-replica-leader-req.png" alt="raft-log-replica-leader-req"></p>
</li>
<li>
<p>大多数节点返回了确认信息后，Leader可以commit并将a设置为1，然后Leader发送请求给Follower说明a=1已经commit，Follower接收到请求后将执行commit操作，此时整个系统就a的值处于一致性状态</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/raft-log-replica-leader-commit.png" alt="raft-log-replica-leader-commit"></p>
</li>
</ol>
<h2 id="一些问题">一些问题</h2>
<h3 id="通过k8s部署的3节点consul先后挂掉两个节点后无法正常工作">通过k8s部署的3节点consul先后挂掉两个节点后无法正常工作</h3>
<ol>
<li>
<p>初始状态下，consul集群工作正常</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/consul-raft-failed-two-node-1.png" alt="consul-raft-failed-two-node-1"></p>
</li>
<li>
<p>刚开始如果1挂掉，此时consul依然能够正常工作，因为活着的两个节点知道彼此的存在，此时0和2上的last_configuration变成了0和2，去掉了挂掉的1节点，但是注意，此时1节点上存储的last_configuration还是0、1、2；</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/consul-raft-failed-two-node-2.png" alt="consul-raft-failed-two-node-2"></p>
</li>
<li>
<p>如果此时1节点起来，然后在1节点加入集群之前，2节点挂掉，此时整个集群的信息如下，因为1还没有加入集群，所以0节点的last_configuration还是存储的0、2；所以如果0要发起投票，只能给2发（但是此时2已经挂掉了），所以0不能依靠投票成为leader；1节点存储了正确的节点信息0、1、2，所以0节点能够正常发起投票，但是1的last_index小于0的last_index，所以1给0发起的投票会被0拒绝，因此1节点也无法通过投票成为leader；此时整个consul集群处于无法工作的状态；</p>
<p><img src="https://ahsup.oss-cn-beijing.aliyuncs.com//draw/consul-raft-failed-two-node-3.png" alt="consul-raft-failed-two-node-3"></p>
<p>看raft的代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">requestVote</span><span class="p">(</span><span class="nx">rpc</span> <span class="nx">RPC</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">RequestVoteRequest</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">metrics</span><span class="p">.</span><span class="nf">MeasureSince</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="s">&#34;raft&#34;</span><span class="p">,</span> <span class="s">&#34;rpc&#34;</span><span class="p">,</span> <span class="s">&#34;requestVote&#34;</span><span class="p">},</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Now</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">observe</span><span class="p">(</span><span class="o">*</span><span class="nx">req</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Setup a response
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">resp</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">RequestVoteResponse</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">RPCHeader</span><span class="p">:</span> <span class="nx">r</span><span class="p">.</span><span class="nf">getRPCHeader</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Term</span><span class="p">:</span>      <span class="nx">r</span><span class="p">.</span><span class="nf">getCurrentTerm</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">		<span class="nx">Granted</span><span class="p">:</span>   <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">rpcErr</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">rpc</span><span class="p">.</span><span class="nf">Respond</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span> <span class="nx">rpcErr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Version 0 servers will panic unless the peers is present. It&#39;s only
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// used on them to produce a warning message.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">protocolVersion</span> <span class="p">&lt;</span> <span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">.</span><span class="nx">Peers</span> <span class="p">=</span> <span class="nf">encodePeers</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latest</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">trans</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Check if we have an existing leader [who&#39;s not the candidate] and also
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// check the LeadershipTransfer flag is set. Usually votes are rejected if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// there is a known leader. But if the leader initiated a leadership transfer,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// vote!
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">candidate</span> <span class="nx">ServerAddress</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">candidateBytes</span> <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">RPCHeader</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">candidate</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">trans</span><span class="p">.</span><span class="nf">DecodePeer</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">RPCHeader</span><span class="p">.</span><span class="nx">Addr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">candidateBytes</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RPCHeader</span><span class="p">.</span><span class="nx">Addr</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">candidate</span> <span class="p">=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">trans</span><span class="p">.</span><span class="nf">DecodePeer</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">candidateBytes</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Candidate</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// For older raft version ID is not part of the packed message
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// We assume that the peer is part of the configuration and skip this check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">candidateID</span> <span class="o">:=</span> <span class="nf">ServerID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// if the Servers list is empty that mean the cluster is very likely trying to bootstrap,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Grant the vote
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latest</span><span class="p">.</span><span class="nx">Servers</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nf">hasVote</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">configurations</span><span class="p">.</span><span class="nx">latest</span><span class="p">,</span> <span class="nx">candidateID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;rejecting vote request since node is not a voter&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">				<span class="s">&#34;from&#34;</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">leaderAddr</span><span class="p">,</span> <span class="nx">leaderID</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">LeaderWithID</span><span class="p">();</span> <span class="nx">leaderAddr</span> <span class="o">!=</span> <span class="s">&#34;&#34;</span> <span class="o">&amp;&amp;</span> <span class="nx">leaderAddr</span> <span class="o">!=</span> <span class="nx">candidate</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">LeadershipTransfer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;rejecting vote request since we have a leader&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;from&#34;</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;leader&#34;</span><span class="p">,</span> <span class="nx">leaderAddr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;leader-id&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">leaderID</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ignore an older term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">r</span><span class="p">.</span><span class="nf">getCurrentTerm</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Increase the term if we see a newer one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nf">getCurrentTerm</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Ensure transition to follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Debug</span><span class="p">(</span><span class="s">&#34;lost leadership because received a requestVote with a newer term&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">setState</span><span class="p">(</span><span class="nx">Follower</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nf">setCurrentTerm</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="nx">resp</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Check if we have voted yet
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">lastVoteTerm</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">stable</span><span class="p">.</span><span class="nf">GetUint64</span><span class="p">(</span><span class="nx">keyLastVoteTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#34;not found&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to get last vote term&#34;</span><span class="p">,</span> <span class="s">&#34;error&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">lastVoteCandBytes</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">stable</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">keyLastVoteCand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">()</span> <span class="o">!=</span> <span class="s">&#34;not found&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to get last vote candidate&#34;</span><span class="p">,</span> <span class="s">&#34;error&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Check if we&#39;ve voted in this election before
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">lastVoteTerm</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Term</span> <span class="o">&amp;&amp;</span> <span class="nx">lastVoteCandBytes</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;duplicate requestVote for same term&#34;</span><span class="p">,</span> <span class="s">&#34;term&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">Compare</span><span class="p">(</span><span class="nx">lastVoteCandBytes</span><span class="p">,</span> <span class="nx">candidateBytes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;duplicate requestVote from&#34;</span><span class="p">,</span> <span class="s">&#34;candidate&#34;</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">resp</span><span class="p">.</span><span class="nx">Granted</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Reject if their term is older
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">lastIdx</span><span class="p">,</span> <span class="nx">lastTerm</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">getLastEntry</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">lastTerm</span> <span class="p">&gt;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">LastLogTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;rejecting vote request since our last term is greater&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;candidate&#34;</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;last-term&#34;</span><span class="p">,</span> <span class="nx">lastTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;last-candidate-term&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">LastLogTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">lastTerm</span> <span class="o">==</span> <span class="nx">req</span><span class="p">.</span><span class="nx">LastLogTerm</span> <span class="o">&amp;&amp;</span> <span class="nx">lastIdx</span> <span class="p">&gt;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">LastLogIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Warn</span><span class="p">(</span><span class="s">&#34;rejecting vote request since our last index is greater&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;candidate&#34;</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;last-index&#34;</span><span class="p">,</span> <span class="nx">lastIdx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="s">&#34;last-candidate-index&#34;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">LastLogIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Persist a vote for safety
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">r</span><span class="p">.</span><span class="nf">persistVote</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">candidateBytes</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">r</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="s">&#34;failed to persist vote&#34;</span><span class="p">,</span> <span class="s">&#34;error&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">resp</span><span class="p">.</span><span class="nx">Granted</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">	<span class="nx">r</span><span class="p">.</span><span class="nf">setLastContact</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果<code>if lastTerm == req.LastLogTerm &amp;&amp; lastIdx &gt; req.LastLogIndex</code> ，则会拒绝投票请求；但是lastIndex是通过<code>appendEntries</code>来更新的，<code>appendEntries</code>只能由leader发起。</p>
</li>
</ol>
<p>k8s部署的consul有如下几个坑：</p>
<ul>
<li>通过statefulset部署的consul集群，在一个宿主机挂掉时间过长的情况下，可能会发送pod漂移，consul pod会迁移到其他节点上去，此时如果使用的存储不是分布式存储而是localpv，会发生丢数据的问题（可以不在server上存储数据来解决这个问题，也可以使用<a href="https://github.com/kubemod/kubemod">kubemod/kubemod: Universal Kubernetes mutating operator (github.com)</a>）；</li>
<li>需要指定node-id，要不然会出现pod重启到其他节点，node-id和pod-ip均发生变化而导致很多奇怪的问题；</li>
<li>部署在k8s中，由于pod-ip不确定，则consul会强依赖k8s的域名解析；</li>
<li>有些分布式存储会在网络或节点压力大的情况下变为<code>read only</code>，注意，这个会导致consul集群直接不工作！挂在的pv变为<code>read only</code>时需要手动删除pod重建pod。</li>
</ul>
<h2 id="有用的链接">有用的链接</h2>
<ul>
<li><a href="http://thesecretlivesofdata.com/raft/">raft</a></li>
</ul>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">hlday</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-03-08
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
          <a href="/tags/go/">go</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/design-pattern/factory_pattern/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">工厂模式</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="hTangle/hxsup-blog-image"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <style>
      utterances {
        max-width: 75%;
        width: 1200px;
      }
    </style>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <link href="https://cdn.staticfile.org/bootstrap/5.0.2/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdn.staticfile.org/bootstrap/5.0.2/js/bootstrap.min.js" crossorigin="anonymous"></script>
<style>
  .modal {
    display: none;
     
    position: fixed;
     
    z-index: 1000;
     
    padding-top: 100px;
     
    left: 0;
    top: 0;
    width: 100%;
     
    height: 100%;
     
    overflow: auto;
     
    background-color: #FFFFFF;
     
    background-color: rgba(255, 255,255, 0.98);
     
  }

   
  .modal-content {
    margin: auto;
    display: block;
  }

   
  .modal-content,
  #caption {
    animation-name: zoom;
    animation-duration: 0.6s;
  }

  @keyframes zoom {
    from {
      transform: scale(0)
    }

    to {
      transform: scale(1)
    }
  }
  .image-show-center {
    display: block !important;
    margin: 0 auto;
    border: 0;
    border-radius: 5px;
     
  }
</style>
<div id="myModal" class="modal" onclick="disShowImage()">
  <img class="modal-content" id="img01" onmousewheel="return zoomImg(this)"
       style="width: auto;height: auto;max-width: 100%;max-height: 100%;">
</div>
<script type="text/javascript">
  var modal = document.getElementById("myModal");
  var modalImg = document.getElementById("img01");
  
  function disShowImage() {
    modal.style.display = "none";
  }
  function zoomImg(obj) {
    
    let zoom = parseInt(obj.style.zoom, 10) || 100;
    
    zoom += event.wheelDelta / 12;
    if (zoom > 0) {
      obj.style.zoom = zoom + '%';
    }
    return false;
  }
  $(function () {
    console.log("init")
    var imgs=$("img");
    for(var i=0;i<imgs.length;i++){
      imgs[i].className="image-show-center rounded";
    }
    
    $("img").on('click', function () {
      console.log("test---", $(this).attr("src"))
      modal.style.display = "block";
      modalImg.style.zoom = "reset";
      modalImg.src = $(this).attr("src");
      imageClicked = true;
    })
    
  })
</script>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="hsup1994@hotmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/hTangle" class="iconfont icon-github" title="github"></a>
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> site pv: <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> site uv: <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2022 - 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span><a href="/">hlday</a></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  



<script type="text/javascript" src="/js/main.min.bfb94e1fe4773651a6fe907d388ed08d7d6f9628a062d0740d992e1dfb49466e.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>








</body>
</html>
